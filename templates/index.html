{# templates/index.html #}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
        }


        .split-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .split-section {
            flex: 1;
        }

        .button-section {
            text-align: center;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<nav class="navbar bg-primary" data-bs-theme="dark">
    <div class="container-fluid justify-content-start">
        <a class="navbar-brand" href="#">Mestastic Node Monitor [{{ name }}]</a>
    </div>
</nav>
<p>&nbsp;</p>
<div class="container-fluid">
    <h2>Packet Totals</h2>
    <table id="summary-table" class="table table-bordered">
        <tr id="summary-headers"></tr>
        <tr id="summary-values"></tr>
    </table>

    <p>&nbsp;</p>

    <div class="split-container">
        <div class="split-section">
            <h2>Messages</h2>
            <table id="messages-table" class="table table-striped">
                <thead>
                <tr>
                    <th>Date Time</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Channel</th>
                    <th>Message</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="split-section">
            <h2>Packets Received</h2>
            <table id="packets-table" class="table table-striped">
                <thead>
                <tr>
                    <th>Date Time</th>
                    <th>Node</th>
                    <th>Hops</th>
                    <th>RSSI</th>
                    <th>Type</th>
                    <th>Information</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<!--
    <div class="button-section">
        <button onclick="window.close()">Quit</button>
    </div>
-->
<!-- Add this modal markup to your HTML -->
<div class="modal fade" id="dynamicModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Content will be loaded here dynamically -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
    function updateTables() {
        console.log('updateTables()...');
        fetch('/api/updates')
            .then(response => response.json())
            .then(data => {
                console.log('Data: ', data);
                // Update summary table
                const summaryHeaders = document.getElementById('summary-headers');
                const summaryValues = document.getElementById('summary-values');

                // Clear existing content
                summaryHeaders.innerHTML = '';
                summaryValues.innerHTML = '';

                // Add new content
                data.summary.columns.forEach(column => {
                    summaryHeaders.innerHTML += `<th>${column}</th>`;
                });
                data.summary.values.forEach(value => {
                    summaryValues.innerHTML += `<td>${value}</td>`;
                });

                // Update messages table
                const messagesBody = document.querySelector('#messages-table tbody');
                messagesBody.innerHTML = '';
                data.messages.forEach(msg => {
                    messagesBody.innerHTML += `
                            <tr>
                                <td>${msg.datetime}</td>
                                <td>${msg.from}</td>
                                <td>${msg.to}</td>
                                <td>${msg.channel}</td>
                                <td>${msg.message}</td>
                            </tr>
                        `;
                });

                // Update packets table
                const packetsBody = document.querySelector('#packets-table tbody');
                packetsBody.innerHTML = '';
                data.packets.forEach(packet => {
                    packetsBody.innerHTML += `
                            <tr>
                                <td>${packet.datetime}</td>
                                <td>${packet.node}</td>
                                <td>${packet.hops}</td>
                                <td>${packet.rssi}</td>
                                <td>${packet.type}</td>
                                <td>${packet.information}</td>
                            </tr>
                        `;
                });
            })
            .catch(error => console.error('Error fetching updates:', error));
    }

    // Initial update
    updateTables();

    // Set up polling every 5 seconds
    setInterval(updateTables, 5000);
</script>

<script>
    function initializeTableActions(tableId) {
        document.getElementById(tableId).addEventListener('click', function (event) {
            const dropdownItem = event.target.closest('.dropdown-item');
            if (!dropdownItem) return;

            event.preventDefault();

            const row = dropdownItem.closest('tr');
            if (!row) {
                console.error('Could not find associated table row');
                return;
            }

            const cells = Array.from(row.cells);

            const rowData = {
                dateTime: cells[0]?.textContent.trim(),
                node: cells[1]?.textContent.trim(),
                hops: cells[2]?.textContent.trim(),
                rssi: cells[3]?.textContent.trim(),
                type: cells[4]?.textContent.trim(),
                information: cells[5]?.textContent.trim(),
                action: dropdownItem.textContent.trim()
            };

            handleAction(rowData);
        });
    }

    function handleAction(rowData) {
        console.log('Action triggered for packet:', rowData);

        const input = "This is a test!capture this\nand this is ignored!";
        const matches = rowData.node.match(/!([^\n]*)/);

        let node_id = '';
        if (matches) {
            node_id = matches[1];
        }
        switch (rowData.action) {
            case 'View Details':
                showDetailsModal(node_id);
                break;
            case 'Download':
                downloadItem(node_id);
                break;
            case 'Open in Map':
                openMap(node_id);
                break;
            default:
                console.log('Unknown action:', rowData.action);
        }
    }


    function downloadItem(rowData) {
        console.log('Downloading packet:', rowData);
    }

    function openMap(rowData) {
        const nodeNum = parseInt(rowData, 16)
        window.open('https://meshtastic.liamcottle.net/?node_id='+ String(nodeNum), "_blank");
    }

    initializeTableActions("packets-table");

    // Initialize the modal
let modal = null;

function showDetailsModal(id) {
    // Initialize modal if not already done
    if (!modal) {
        modal = new bootstrap.Modal(document.getElementById('dynamicModal'));
    }

    // Clear previous content
    const modalBody = document.querySelector('#dynamicModal .modal-body');
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

    // Show the modal
    modal.show();

    // Fetch the content
    fetch(`/api/details?id=${encodeURIComponent(id)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(html => {
            modalBody.innerHTML = html;
        })
        .catch(error => {
            modalBody.innerHTML = `<div class="alert alert-danger">Error loading content: ${error.message}</div>`;
        });
}
</script>
</body>
</html>